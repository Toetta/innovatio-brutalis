<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Innovatio Brutalis CMS</title>
    <script>
      // Keep a single canonical origin for OAuth + storage.
      if (location.hostname === 'innovatio-brutalis.se') {
        location.replace(`https://www.innovatio-brutalis.se${location.pathname}${location.search}${location.hash}`);
      }
    </script>
  </head>
  <body>
    <script>
      // Decap CMS image previews sometimes break when:
      // 1) Older entries store paths like "assets/uploads/foo.jpg" (missing leading '/'), which resolves to "/admin/assets/uploads/...".
      // 2) New uploads exist in GitHub, but your static host hasn't redeployed yet (so "/assets/uploads/..." 404s briefly).
      //
      // This normalizes those URLs inside the CMS UI only, by rewriting to GitHub raw URLs.
      (function () {
        const RAW_BASE = 'https://raw.githubusercontent.com/Toetta/innovatio-brutalis/main/';
        const cacheBust = String(Date.now());

        const rewriteUploadsSrc = (value) => {
          if (!value || typeof value !== 'string') return null;
          const v = value.trim();
          if (!v) return null;

          // Avoid infinite rewriting
          if (v.startsWith(RAW_BASE)) return null;

          // Skip non-path URLs
          if (v.startsWith('data:') || v.startsWith('blob:')) return null;
          if (/^https?:\/\//i.test(v)) return null;

          // Normalize common variants
          const normalized = v.startsWith('/') ? v.slice(1) : v;
          if (!normalized.startsWith('assets/uploads/')) return null;

          return RAW_BASE + normalized + '?v=' + cacheBust;
        };

        const maybeRewriteImg = (img) => {
          try {
            if (!img || img.tagName !== 'IMG') return;
            const attr = img.getAttribute('src');
            const next = rewriteUploadsSrc(attr);
            if (next) img.setAttribute('src', next);
          } catch (_) {}
        };

        const fixImages = (root) => {
          try {
            if (!root) root = document;
            if (root.tagName === 'IMG') maybeRewriteImg(root);
            const imgs = root.querySelectorAll?.('img[src]');
            if (!imgs) return;
            for (const img of imgs) maybeRewriteImg(img);
          } catch (_) {}
        };

        // Initial pass + keep updating as React renders.
        fixImages(document);

        try {
          const mo = new MutationObserver((mutations) => {
            for (const m of mutations) {
              if (m.type === 'attributes' && m.attributeName === 'src' && m.target?.tagName === 'IMG') {
                maybeRewriteImg(m.target);
              } else if (m.type === 'childList') {
                for (const n of m.addedNodes || []) {
                  if (!n || n.nodeType !== 1) continue;
                  if (n.tagName === 'IMG') maybeRewriteImg(n);
                  fixImages(n);
                }
              }
            }
          });
          mo.observe(document.documentElement, { subtree: true, childList: true, attributes: true, attributeFilter: ['src'] });
        } catch (_) {}
      })();
    </script>
    <script src="https://unpkg.com/decap-cms@^3/dist/decap-cms.js"></script>
  </body>
</html>