<!doctype html>
<meta charset="utf-8" />
<title>Spotify Callback</title>
<p>Loggar in…</p>
<script src="./spotify-player.js"></script>
<script>
  // Den här sidan byter “code” → access token och skickar tillbaka till startsidan
  (async () => {
    try {
      await SpotifySite.handleCallback();

      // Efter login: om en sida har begärt en return path, gå tillbaka dit.
      // Säkerhet: tillåt bara same-origin paths.
      let target = "/";
      try {
        const raw = localStorage.getItem("spotify_post_login_redirect") || "";
        localStorage.removeItem("spotify_post_login_redirect");
        const p = String(raw).trim();
        if (p && p.startsWith("/") && !p.startsWith("//") && !p.includes("://")) {
          target = p;
        }
      } catch (_) {}

      location.href = target;
    } catch (e) {
      console.error(e);
      document.body.innerHTML = "<p>Login misslyckades. Kolla Console.</p>";
    }
  })();
</script>
