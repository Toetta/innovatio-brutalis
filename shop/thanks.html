<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tack – Innovatio Brutalis</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/shop/shop.css" />
</head>
<body>
  <div class="container">
    <div id="site-topbar"></div>
    <script defer src="/assets/site.js"></script>
    <script defer src="/assets/site-deeplinks.js"></script>

    <main>
      <section class="card" style="margin-top:16px">
        <h1 style="margin-top:0">Tack!</h1>
        <p id="msg" style="margin-top:0; color:var(--text-muted)">Kontrollerar orderstatus…</p>
        <div id="details" style="margin-top:12px"></div>
        <div style="margin-top:14px">
          <a class="btn" href="/shop/">Tillbaka till webshop</a>
        </div>
      </section>
    </main>
  </div>

  <script>
    (function () {
      var msg = document.getElementById('msg');
      var details = document.getElementById('details');
      var params = new URLSearchParams(window.location.search || '');
      var orderId = params.get('order') || '';
      var token = params.get('token') || '';

      var esc = function (s) {
        return String(s || '').replace(/[&<>"']/g, function (ch) {
          return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]);
        });
      };

      var fmt = function (amount, currency) {
        var n = Number(amount);
        if (!isFinite(n)) return '';
        try { return new Intl.NumberFormat('sv-SE', { style:'currency', currency: currency || 'SEK' }).format(n); }
        catch (_) { return n + ' ' + (currency || 'SEK'); }
      };

      var to2 = function (n) {
        var x = Number(n);
        if (!isFinite(x)) return 0;
        return Math.round(x * 100) / 100;
      };

      var EU = {
        AT:1,BE:1,BG:1,HR:1,CY:1,CZ:1,DK:1,EE:1,FI:1,FR:1,DE:1,GR:1,HU:1,IE:1,IT:1,LV:1,LT:1,LU:1,MT:1,NL:1,PL:1,PT:1,RO:1,SK:1,SI:1,ES:1,SE:1
      };
      var VAT_RATES = {
        AT:0.2,BE:0.21,BG:0.2,HR:0.25,CY:0.19,CZ:0.21,DK:0.25,EE:0.22,FI:0.24,FR:0.2,DE:0.19,GR:0.24,HU:0.27,IE:0.23,IT:0.22,LV:0.21,LT:0.21,LU:0.17,MT:0.18,NL:0.21,PL:0.23,PT:0.23,RO:0.19,SK:0.2,SI:0.22,ES:0.21,SE:0.25
      };
      var getRate = function (cc) {
        var c = String(cc || 'SE').trim().toUpperCase();
        if (c === 'SE') return 0.25;
        if (!EU[c]) return 0.0;
        var r = VAT_RATES[c];
        return isFinite(Number(r)) ? Number(r) : 0.0;
      };

      var calcVatFromInc = function (totalInc, country, rateOverride) {
        var inc = Number(totalInc);
        if (!isFinite(inc)) return { ex: 0, vat: 0, rate: 0 };
        var c = String(country || 'SE').trim().toUpperCase();
        var rate = isFinite(Number(rateOverride)) ? Number(rateOverride) : getRate(c);
        var ex = rate > 0 ? (inc / (1 + rate)) : inc;
        var vat = inc - ex;
        return { ex: to2(ex), vat: to2(vat), rate: rate };
      };

      if (!orderId || !token) {
        msg.textContent = 'Saknar order-id eller token.';
        return;
      }

      var fetchStatus = function () {
        return fetch('/api/orders-public/' + encodeURIComponent(orderId) + '?token=' + encodeURIComponent(token), {
          credentials: 'include',
          cache: 'no-store',
          headers: { 'accept': 'application/json' }
        }).then(function (r) { return r.json(); });
      };

      var tryVerifyKlarna = function () {
        return fetch('/api/payments/klarna/verify', {
          method: 'POST',
          credentials: 'include',
          cache: 'no-store',
          headers: { 'content-type': 'application/json', 'accept': 'application/json' },
          body: JSON.stringify({ order_id: orderId, token: token })
        }).then(function (r) { return r.json(); }).catch(function () { return null; });
      };

      var tick = 0;
      var poll = function () {
        tick++;
        fetchStatus().then(function (data) {
          if (!data || !data.ok || !data.order) throw new Error('Bad response');
          var o = data.order;
          var cc = String(o.customer_country || 'SE');
          var currency = o.currency || 'SEK';
          var rate = isFinite(Number(o.vat_rate)) ? Number(o.vat_rate) : getRate(cc);
          var calc = calcVatFromInc(o.total_inc_vat, cc, rate);
          var ex = isFinite(Number(o.subtotal_ex_vat)) ? Number(o.subtotal_ex_vat) : calc.ex;
          var vat = isFinite(Number(o.vat_total)) ? Number(o.vat_total) : calc.vat;
          var pct = Math.round((rate || 0) * 100);
          var mode = String(o.tax_mode || '');
          var vatLabel = 'Moms (' + esc(String(pct)) + '%):';
          if (mode === 'reverse_charge') vatLabel = 'Moms (' + esc(String(pct)) + '%, omvänd skattskyldighet):';
          else if (mode === 'export') vatLabel = 'Moms (' + esc(String(pct)) + '%, export):';
          details.innerHTML = ''
            + '<div><strong>Order:</strong> ' + esc(o.order_number) + '</div>'
            + '<div><strong>Status:</strong> ' + esc(o.status) + '</div>'
            + '<div><strong>Summa exkl. moms:</strong> ' + esc(fmt(ex, currency)) + '</div>'
            + '<div><strong>' + vatLabel + '</strong> ' + esc(fmt(vat, currency)) + '</div>'
            + '<div><strong>Summa inkl. moms:</strong> ' + esc(fmt(o.total_inc_vat, currency)) + '</div>';

          if (o.status === 'paid') msg.textContent = 'Betalning mottagen.';
          else if (o.status === 'failed') msg.textContent = 'Betalningen misslyckades.';
          else if (o.status === 'cancelled') msg.textContent = 'Ordern avbröts.';
          else if (o.status === 'refunded') msg.textContent = 'Ordern är återbetalad.';
          else msg.textContent = 'Betalning behandlas…';

          if (o.status === 'paid' || o.status === 'failed' || o.status === 'cancelled' || o.status === 'refunded') return;

          // If still awaiting action, attempt server-side verification (Klarna) in the background.
          if (o.status === 'awaiting_action' || o.status === 'pending_payment') {
            tryVerifyKlarna().then(function () {
              if (tick < 60) setTimeout(poll, 1500);
            });
            return;
          }

          if (tick < 60) setTimeout(poll, 2000);
        }).catch(function () {
          if (tick < 60) setTimeout(poll, 2500);
          else msg.textContent = 'Kunde inte läsa status.';
        });
      };

      poll();
    })();
  </script>
</body>
</html>
