<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spotify tracks builder</title>
  <link rel="stylesheet" href="../css/style.css" />
</head>
<body>
  <div class="container" style="max-width: 860px;">
    <h1>Spotify tracks builder</h1>
    <p style="opacity:.85;max-width:70ch">
      Den här sidan används för att generera <code>/assets/spotify-tracks.json</code> (alla låtar i en playlist)
      så att startsidan kan spela <em>dagens låt</em> för alla utan OAuth.
    </p>

    <section class="card" style="margin-top:18px;">
      <h2>1) Playlist</h2>
      <label for="playlistId" style="display:block;margin:8px 0 6px;opacity:.85">Playlist ID</label>
      <input id="playlistId" type="text" value="7h1c4DGKumkFVXH2N8eMFu" style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:inherit" />

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button id="loginBtn" class="btn small" type="button">Logga in med Spotify</button>
        <button id="generateBtn" class="btn small" type="button">Generate JSON</button>
        <button id="autoSaveBtn" class="btn small" type="button" style="display:none">Auto-save to /assets/spotify-tracks.json</button>
        <a id="downloadLink" class="btn small" href="#" style="display:none">Download spotify-tracks.json</a>
        <button id="copyBtn" class="btn small" type="button" style="display:none">Copy JSON</button>
      </div>

      <div id="status" style="margin-top:10px;opacity:.85"></div>
      <pre id="out" style="margin-top:12px;max-height:420px;overflow:auto;background:rgba(0,0,0,.22);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.08)"></pre>

      <hr class="sep" />
      <h2>2) Krav</h2>
      <ul>
        <li>Du måste vara inloggad så att <code>spotify_access_token</code> finns i <code>localStorage</code>.</li>
        <li>Du kan logga in här via knappen, eller på startsidan (whitelisted user i Spotify Dashboard, development mode).</li>
        <li>Den här sidan ändrar inget i din Spotify-app; den bara läser playlisten via Web API.</li>
      </ul>
    </section>

    <footer style="margin:18px 0 40px;opacity:.75">
      <div>Tips: öppna sidan på <code>/assets/spotify-tracks-builder.html</code></div>
    </footer>
  </div>

  <script src="../spotify-player.js"></script>
  <script>
    const statusEl = document.getElementById('status');
    const outEl = document.getElementById('out');
    const playlistInput = document.getElementById('playlistId');
    const loginBtn = document.getElementById('loginBtn');
    const generateBtn = document.getElementById('generateBtn');
    const autoSaveBtn = document.getElementById('autoSaveBtn');
    const downloadLink = document.getElementById('downloadLink');
    const copyBtn = document.getElementById('copyBtn');

    const isLocal =
      location.hostname === '127.0.0.1' ||
      location.hostname === 'localhost' ||
      location.hostname === '::1';

    const REDIRECT_URI = `${location.origin}/callback.html`;

    let SPOTIFY_CLIENT_ID = 'c8efeac0956c4a9f831bb9238e23f5c3';
    try {
      const savedClientId = localStorage.getItem('spotify_client_id');
      if (savedClientId) {
        const candidate = String(savedClientId).trim();
        if (candidate && candidate !== 'FYLL_I_DIN_CLIENT_ID') {
          SPOTIFY_CLIENT_ID = candidate;
        }
      }
    } catch (_) {}

    const SAVE_SERVER = 'http://127.0.0.1:8787/save';

    if (isLocal && autoSaveBtn) autoSaveBtn.style.display = '';

    function setStatus(t){ statusEl.textContent = t || ''; }

    function hasValidToken(){
      try {
        const t = localStorage.getItem('spotify_access_token');
        const exp = Number(localStorage.getItem('spotify_token_expires_at') || 0);
        if (!t || !exp) return false;
        return Date.now() <= exp;
      } catch (_) {
        return false;
      }
    }

    function updateUi(){
      const ok = hasValidToken();
      if (loginBtn) loginBtn.style.display = ok ? 'none' : '';
    }

    function getToken(){
      try {
        const t = localStorage.getItem('spotify_access_token');
        const exp = Number(localStorage.getItem('spotify_token_expires_at') || 0);
        if (!t || !exp) return null;
        if (Date.now() > exp) return null;
        return t;
      } catch (_) {
        return null;
      }
    }

    async function fetchAllTracks({ playlistId, market='SE' }){
      const token = getToken();
      if (!token) throw new Error('Missing/expired token. Logga in först (knappen ovan eller via startsidan).');

      let url = `https://api.spotify.com/v1/playlists/${encodeURIComponent(playlistId)}/tracks?limit=100&offset=0&market=${encodeURIComponent(market)}`;
      const tracks = [];

      while (url) {
        const r = await fetch(url, {
          method: 'GET',
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!r.ok) {
          const txt = await r.text().catch(()=> '');
          throw new Error(`Spotify API ${r.status}: ${txt}`);
        }
        const j = await r.json();
        for (const it of (j.items || [])) {
          const id = it?.track?.id;
          if (id) tracks.push(`https://open.spotify.com/track/${id}`);
        }
        url = j.next;
        setStatus(`Fetching… ${tracks.length} tracks…`);
      }

      return tracks;
    }

    function buildJson({ playlistId, tracks }){
      const obj = {
        updated: new Date().toISOString().slice(0,10),
        source: `https://open.spotify.com/playlist/${playlistId}`,
        tracks
      };
      return JSON.stringify(obj, null, 2);
    }

    function makeDownload(jsonText){
      const blob = new Blob([jsonText], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      downloadLink.href = url;
      downloadLink.download = 'spotify-tracks.json';
      downloadLink.style.display = '';
    }

    async function autoSaveToRepo(jsonText){
      if (!isLocal) return { ok: false, error: 'Not local' };
      try {
        const r = await fetch(SAVE_SERVER, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: jsonText
        });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) return { ok: false, error: j?.error || `HTTP ${r.status}` };
        return { ok: true, result: j };
      } catch (e) {
        return { ok: false, error: String(e?.message || e || 'Fetch failed') };
      }
    }

    generateBtn.addEventListener('click', async () => {
      updateUi();
      outEl.textContent = '';
      downloadLink.style.display = 'none';
      copyBtn.style.display = 'none';

      const playlistId = String(playlistInput.value || '').trim();
      if (!playlistId) {
        setStatus('Enter a playlist id');
        return;
      }

      setStatus('Starting…');
      try {
        const tracks = await fetchAllTracks({ playlistId });
        const unique = Array.from(new Set(tracks));
        const jsonText = buildJson({ playlistId, tracks: unique });

        outEl.textContent = jsonText;
        makeDownload(jsonText);
        copyBtn.style.display = '';

        // Auto-save if local (requires the save server running)
        if (isLocal) {
          setStatus(`Generated ${unique.length} tracks. Auto-saving…`);
          const saved = await autoSaveToRepo(jsonText);
          if (saved.ok) {
            setStatus(`Done. ${unique.length} unique tracks. Saved to /assets/spotify-tracks.json`);
          } else {
            setStatus(`Generated ${unique.length} tracks. Auto-save failed: ${saved.error}. Use Download/Copy instead, or start the save server.`);
          }
        } else {
          setStatus(`Done. ${unique.length} unique tracks.`);
        }
      } catch (e) {
        console.error(e);
        setStatus(String(e?.message || e || 'Error'));
      }
    });

    autoSaveBtn?.addEventListener('click', async () => {
      try {
        updateUi();
        const txt = outEl.textContent || '';
        if (!txt) {
          setStatus('Nothing to save yet. Press Generate JSON first.');
          return;
        }
        setStatus('Auto-saving…');
        const saved = await autoSaveToRepo(txt);
        if (saved.ok) setStatus('Saved to /assets/spotify-tracks.json');
        else setStatus(`Auto-save failed: ${saved.error}`);
      } catch (e) {
        console.error(e);
        setStatus('Auto-save failed (see console).');
      }
    });

    copyBtn.addEventListener('click', async () => {
      try {
        updateUi();
        const txt = outEl.textContent || '';
        if (!txt) return;
        await navigator.clipboard.writeText(txt);
        setStatus('Copied JSON to clipboard.');
      } catch (e) {
        console.error(e);
        setStatus('Copy failed (check browser permissions).');
      }
    });

    loginBtn?.addEventListener('click', async () => {
      try {
        if (!window.SpotifySite) {
          setStatus('spotify-player.js saknas/laddades inte.');
          return;
        }

        if (!SPOTIFY_CLIENT_ID) {
          setStatus('Saknar Spotify Client ID.');
          return;
        }

        // Tell callback.html where to return after login.
        try { localStorage.setItem('spotify_post_login_redirect', location.pathname); } catch (_) {}

        setStatus('Öppnar Spotify login…');
        window.SpotifySite.login({
          clientId: SPOTIFY_CLIENT_ID,
          redirectUri: REDIRECT_URI,
          showDialog: false,
        });
      } catch (e) {
        console.error(e);
        setStatus('Login-fel (se console).');
      }
    });

    // Initial state
    updateUi();
    if (!hasValidToken()) {
      setStatus('Inte inloggad. Klicka “Logga in med Spotify”.');
    }
  </script>
</body>
</html>
