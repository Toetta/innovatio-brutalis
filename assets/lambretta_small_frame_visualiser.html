<!doctype html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-LGJK9XKDZB"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-LGJK9XKDZB');
  </script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lambretta Small Frame Gearbox Visualiser</title>
  <style>
    :root {
      --bg:#191717;
      --bg2:#141212;
      --bg-rgb:25,23,23;
      --card-rgb:33,31,31;
      --card2-rgb:40,38,38;
      --line-rgb:34,48,68;

      --panel: rgba(var(--card-rgb), .94);
      --panel2: rgba(var(--card2-rgb), .98);
      --line: rgba(var(--line-rgb), .55);
      --text: #e5e7eb;
      --muted: #94a3b8;
      --accent: #60a5fa;
      --rowH: 34px;
      --radius: 16px;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: linear-gradient(180deg, var(--bg), var(--bg2));
      color: var(--text);
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    header {
      max-width: 1250px;
      margin: 28px auto 10px;
      padding: 0 16px;
    }
    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: 0.2px;
    }
    .sub {
      margin: 6px 0 0;
      color: var(--muted);
    }

    .wrap {
      max-width: 1250px;
      margin: 0 auto 40px;
      padding: 0 16px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: visible;
      }

    .controls {
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
      align-items: start;
    }
    @media (max-width: 980px) {
      .controls { grid-template-columns: repeat(auto-fit, minmax(290px, 1fr)); }
      .row { grid-template-columns: 1fr; }
    }

    .card {
      background: rgba(var(--card-rgb), .85);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
    }
    .card h3 {
      margin: 0 0 10px;
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: .2px;
      text-transform: uppercase;
    }

    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin: 8px 0 6px;
    }

    input[type="number"], select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(var(--card-rgb), .85);
      color: var(--text);
      outline: none;
    }
    input[type="number"]:focus, select:focus {
      border-color: rgba(75,179,255,0.6);
      box-shadow: 0 0 0 3px rgba(75,179,255,0.15);
    }

    select{ color-scheme: dark; }
    select option{ background: rgba(var(--card2-rgb), .98); color: var(--text); }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .inline {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      appearance: none;
      border: 1px solid var(--line);
      background: rgba(0,0,0,0.35);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      user-select: none;
    }
    .btn:hover { border-color: rgba(255,255,255,0.18); }
    .btn:active { transform: translateY(1px); }

    .pillbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 10px 14px 14px;
      border-bottom: 1px solid var(--line);
    }
    .pill {
      border: 1px solid var(--line);
      background: rgba(0,0,0,0.35);
      border-radius: 999px;
      padding: 8px 10px;
      color: var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      white-space: nowrap;
    }

    .table-wrap {
      overflow: auto;
      min-height: 220px;
      -webkit-overflow-scrolling: touch;
      max-height: 75vh;
      background: rgba(0,0,0,0.12);
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 980px;
    }
    thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(12,16,22,0.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
      font-size: 12px;
      color: rgba(255,255,255,0.75);
      text-transform: uppercase;
      letter-spacing: .12em;
      padding: 10px 8px;
      white-space: nowrap;
    }
    thead tr:first-child th {
      border-bottom: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.80);
      letter-spacing: .16em;
    }

    tbody td {
      border-bottom: 1px solid rgba(255,255,255,0.06);
      border-right: 1px solid rgba(255,255,255,0.06);
      padding: 0 8px;
      height: var(--rowH);
      text-align: center;
      white-space: nowrap;
      background: rgba(0,0,0,0.18);
      font-variant-numeric: tabular-nums;
    }
    tbody tr td:first-child { border-left: 1px solid rgba(255,255,255,0.06); }

    td.speed {
      background: rgba(0,0,0,0.32);
      color: rgba(255,255,255,0.9);
      font-weight: 650;
      border-right: 1px solid rgba(255,255,255,0.12);
      border-left: 1px solid rgba(255,255,255,0.12);
    }

    td.rpm {
      font-weight: 700;
    }

    .zoomRow {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    input[type="range"] {
      width: 220px;
    }
    .smallNote {
      font-size: 12px;
      color: var(--muted);
    }
  
    .infoBox{
      border: 1px solid var(--line);
      background: rgba(0,0,0,0.14);
      border-radius: 14px;
      padding: 10px;
    }
    .infoBox h4{
      margin: 0 0 8px;
      font-size: 12px;
      letter-spacing: .5px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.82);
    }
    .kv{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap: 6px 10px;
      font-size: 12px;
      color: rgba(255,255,255,0.86);
      margin-bottom: 8px;
    }
    .kv .k{ color: rgba(255,255,255,0.62); }
    .miniTable{
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .miniTable th, .miniTable td{
      border-bottom: 1px solid rgba(255,255,255,0.10);
      padding: 6px 6px;
      white-space: nowrap;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .miniTable th:first-child, .miniTable td:first-child{ text-align:left; }
    .miniTable thead th{
      color: rgba(255,255,255,0.70);
      font-weight: 700;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: .4px;
    }
    .muted{
      color: rgba(255,255,255,0.62);
    }

  
    /* --- Layout fixes: allow grid children to shrink (prevents crazy compression) --- */
    .controls > * { min-width: 0; }
    .row > * { min-width: 0; }
    .detailsGrid > * { min-width: 0; }

    /* Keep gearbox details from forcing huge min-content widths */
    .infoBox { overflow: auto; }
    .miniTableWrap { overflow-x: auto; }
    .miniTable { min-width: 520px; }

  

    /* FINAL3 layout + scroll reliability */
    .panel{ overflow: visible; }
    .controls > *{ min-width: 0; }
    .row > *{ min-width: 0; }
    select, input{ min-width: 0; }

    /* Make the RPM table area an obvious scroll region */
    .table-wrap{
      height: clamp(320px, 60vh, 78vh);
      overflow: auto;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }

    /* Sticky headers can break scrolling on some browsers; keep it simple */
    thead th{ position: static; }

    /* Details panels: don't trap vertical scrolling; only allow horizontal for the table */
    .infoBox{ overflow: visible; }
    .miniTableWrap{ overflow-x: auto; -webkit-overflow-scrolling: touch; }


    /* Details layout: stack A/B so it stays readable inside the Setup panel */
    .detailsGrid{
      display:grid;
      grid-template-columns: 1fr; /* default: stacked */
      gap: 12px;
      margin-top: 12px;
    }
    /* Only show side-by-side on truly wide screens */
    @media (min-width: 1400px){
      .detailsGrid{ grid-template-columns: 1fr 1fr; }
    }

    .infoBox{
      border: 1px solid var(--line);
      background: rgba(0,0,0,0.14);
      border-radius: 14px;
      padding: 12px;
      overflow: visible;
    }
    .infoBox h4{
      margin: 0 0 10px;
      font-size: 12px;
      letter-spacing: .5px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.82);
    }

    /* Key/value list: allow values to wrap instead of crushing columns */
    .kv{
      display:grid;
      grid-template-columns: 140px minmax(0, 1fr);
      gap: 6px 12px;
      font-size: 12px;
      color: rgba(255,255,255,0.86);
      margin-bottom: 10px;
      align-items: start;
    }
    .kv .k{
      color: rgba(255,255,255,0.62);
      white-space: nowrap;
    }
    .kv > div{
      min-width: 0;
      overflow-wrap: anywhere;
      word-break: break-word;
      line-height: 1.35;
    }

    /* Keep gearbox detail table from messing up layout */
    .miniTableWrap{ overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .miniTable{
      width: 100%;
      min-width: 560px;
      border-collapse: collapse;
      font-size: 12px;
    }
    .miniTable th, .miniTable td{
      border-bottom: 1px solid rgba(255,255,255,0.10);
      padding: 6px 8px;
      white-space: nowrap;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .miniTable th:first-child, .miniTable td:first-child{ text-align:left; }
    .miniTable thead th{
      color: rgba(255,255,255,0.70);
      font-weight: 700;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: .4px;
    }


    /* Collapsible gearbox details (prevents huge empty space under shorter cards) */
    .detailsToggle{
      margin-top: 12px;
      border: 1px solid var(--line);
      border-radius: 18px;
      background: rgba(0,0,0,0.14);
      padding: 10px 12px;
    }
    .detailsToggle > summary{
      cursor: pointer;
      list-style: none;
      font-weight: 800;
      letter-spacing: .4px;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,0.86);
      user-select: none;
      outline: none;
    }
    .detailsToggle > summary::-webkit-details-marker{ display:none; }
    .detailsToggle > summary:after{
      content: "▾";
      float: right;
      opacity: .7;
    }
    .detailsToggle[open] > summary:after{ content:"▴"; }
    .detailsToggle .detailsGrid{ margin-top: 10px; }

    /* Details layout */
    .detailsGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 1400px){
      .detailsGrid{ grid-template-columns: 1fr 1fr; }
    }


    /* Details under RPM table: always visible, A left / B right */
    .detailsBelow{
      margin-top: 12px;
      border: 1px solid var(--line);
      border-radius: 18px;
      background: rgba(0,0,0,0.14);
      padding: 12px;
    }
    .detailsRow{
      display: grid;
      grid-template-columns: repeat(2, minmax(420px, 1fr));
      gap: 12px;
      overflow-x: auto;              /* if screen too narrow, scroll sideways instead of crushing */
      -webkit-overflow-scrolling: touch;
    }
    .detailsRow > .infoBox{ min-width: 420px; }
</style>
</head>
<body>
  <header>
    <h1>Lambretta Small Frame Gearbox Visualiser</h1>
    <div id="errorBanner" style="display:none;margin:12px 0;padding:10px 12px;border:1px solid rgba(255,90,90,0.5);border-radius:12px;background:rgba(255,90,90,0.10);color:rgba(255,255,255,0.92);font-size:13px;"></div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="controls">
        <div class="card">
          <h3>Display</h3>
          <div class="row">
            <div>
              <label for="unit">Units</label>
              <select id="unit">
                <option value="kmh" selected>km/h</option>
                <option value="mph">mph</option>
              </select>
            </div>
            <div>
              <label for="step">Speed step</label>
              <input id="step" type="number" min="0.5" step="0.5"/>
            </div>
          </div>

          <label>Row height</label>
          <div class="zoomRow">
            <button class="btn" id="rhMinus" title="Smaller">−</button>
            <input id="rowHeight" type="range" min="40" max="140" value="100"/>
            <button class="btn" id="rhPlus" title="Larger">+</button>
            <button class="btn" id="fit" title="Fit table to screen">Fit</button>
            <span class="smallNote" id="rowHeightLabel">100%</span>
          </div>

          <div class="inline" style="margin-top:10px;">
            <button class="btn" id="save">Save</button>
            <button class="btn" id="load">Load</button>
            <button class="btn" id="reset">Reset</button>
          </div>
        </div>

        <div class="card">
          <h3>Engine RPM bands</h3>
          <div class="row">
            <div>
              <label for="rpmIn">Power comes in (rpm)</label>
              <input id="rpmIn" type="number" step="50"/>
            </div>
            <div>
              <label for="rpmPeak">Peak power (rpm)</label>
              <input id="rpmPeak" type="number" step="50"/>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="rpmShift">Change up / tail off (rpm)</label>
              <input id="rpmShift" type="number" step="50"/>
            </div>
            <div>
              <label for="rpmMax">Max rpm</label>
              <input id="rpmMax" type="number" step="50"/>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="rpmIdle">Idle rpm (hide below)</label>
              <input id="rpmIdle" type="number" step="50"/>
            </div>
            <div></div>
          </div>
        </div>

        <div class="card">
          <h3>Setup A vs B</h3>
          <div class="row">
            <div>
              <label for="gbA">Gearbox (A)</label>
              <select id="gbA"></select>

              <label for="tyreA">Tyre (A)</label>
              <select id="tyreA"></select>

              <div class="row">
                <div>
                  <label for="sprA">Engine sprocket (teeth)</label>
                  <input id="sprA" type="number" min="1" step="1" list="sprList"/>
                </div>
                <div>
                  <label for="cwA">Crown wheel (teeth)</label>
                  <input id="cwA" type="number" min="1" step="1" list="cwList"/>
                </div>
              </div>
            </div>

            <div>
              <label for="gbB">Gearbox (B)</label>
              <select id="gbB"></select>

              <label for="tyreB">Tyre (B)</label>
              <select id="tyreB"></select>

              <div class="row">
                <div>
                  <label for="sprB">Engine sprocket (teeth)</label>
                  <input id="sprB" type="number" min="1" step="1" list="sprList"/>
                </div>
                <div>
                  <label for="cwB">Crown wheel (teeth)</label>
                  <input id="cwB" type="number" min="1" step="1" list="cwList"/>
                </div>
              </div>
            </div>
          </div>

          <datalist id="sprList"></datalist>
          <datalist id="cwList"></datalist>
        </div>
      </div>
</div>
      </div>

      <div class="pillbar" id="pills">
        <span class="pill" id="maxA">A max @ max rpm: —</span>
        <span class="pill" id="maxB">B max @ max rpm: —</span>
        <span class="pill" id="maxAuto">Auto max speed: —</span>
      </div>
<div class="table-wrap" id="tableWrap">
        <table id="tbl">
          <thead>
            <tr>
              <th colspan="5">Setup A RPM</th>
              <th colspan="1">Speed</th>
              <th colspan="5">Setup B RPM</th>
            </tr>
            <tr>
              <th>1st RPM</th><th>2nd RPM</th><th>3rd RPM</th><th>4th RPM</th><th>5th RPM</th>
              <th id="speedHead">km/h</th>
              <th>1st RPM</th><th>2nd RPM</th><th>3rd RPM</th><th>4th RPM</th><th>5th RPM</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

    <section class="detailsBelow" aria-label="Gearbox and chain details">
      <div class="detailsRow">
        <div class="infoBox">
          <h4>Setup A</h4>
          <div id="infoA"></div>
        </div>
        <div class="infoBox">
          <h4>Setup B</h4>
          <div id="infoB"></div>
        </div>
      </div>
    </section>

    </div>
  </div>

<script type="application/json" id="DATA_JSON">{"gearboxes": [{"label": "FACTORY SMALL FRAME", "items": [{"id": 2, "name": "J50 Early production", "gears": [[69, 10], [64, 16], [56, 22], [null, null], [null, null], [null, null]], "note": null}, {"id": 3, "name": "J50 Mid Production", "gears": [[53, 9], [54, 14], [47, 19], [null, null], [null, null], [null, null]], "note": null}, {"id": 4, "name": "J50 Deluxe + J50 Special + Lui 50C / CL", "gears": [[58, 9], [53, 15], [46, 20], [null, null], [null, null], [null, null]], "note": null}, {"id": 5, "name": "Lui Vega Cometa 75cc", "gears": [[49, 9], [46, 13], [42, 16], [39, 20], [null, null], [null, null]], "note": null}, {"id": 6, "name": "Cento 100cc", "gears": [[48, 10], [43, 15], [39, 21], [null, null], [null, null], [null, null]], "note": null}, {"id": 7, "name": "J125 3-Speed", "gears": [[48, 11], [42, 16], [37, 21], [null, null], [null, null], [null, null]], "note": null}, {"id": 8, "name": "J125 4-Speed Starstream + Super Starstream", "gears": [[48, 11], [44, 14], [37, 16], [34, 19], [null, null], [null, null]], "note": null}, {"id": 9, "name": "Indian Sunny FR / Cento 100", "gears": [[49, 9], [43, 15], [39, 21], [null, null], [null, null], [null, null]], "note": null}]}, {"label": "RLC Vega5", "items": [{"id": 12, "name": "RLC Vega5 for J Range + Lui (all models)", "gears": [[44, 10], [41, 13], [37, 16], [33, 18], [31, 20], [null, null]], "note": null}]}, {"label": "CUSTOM GEARBOXES", "items": [{"id": 15, "name": "Luna SE", "gears": [[58, 9], [55, 13], [51, 17], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 16, "name": "LUNA PERFECT", "gears": [[58, 10], [53, 15], [46, 19], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 17, "name": "Custom 3", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 18, "name": "Custom 4", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 19, "name": "Custom 5", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 20, "name": "Custom 6", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 21, "name": "Custom 7", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 22, "name": "Custom 8", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 23, "name": "Custom 9", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 24, "name": "Custom 10", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 25, "name": "Custom 11", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 26, "name": "Custom 12", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 27, "name": "Custom 13", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 28, "name": "Custom 14", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 29, "name": "Custom 15", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 30, "name": "Custom 16", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 31, "name": "Custom 17", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 32, "name": "Custom 18", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 33, "name": "Custom 19", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}, {"id": 34, "name": "Custom 20", "gears": [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0], [null, null]], "note": null}]}], "tyres": [{"label": "Default", "items": [{"id": 1, "name": "Default 3.00-10 (126.9 cm)", "circ_cm": 126.9, "circ_m": 1.2690000000000001}, {"id": 2, "name": "Default 3.50-10 (135.7 cm)", "circ_cm": 135.7, "circ_m": 1.357}, {"id": 3, "name": "Default 3.00-12 (143.0 cm)", "circ_cm": 143.0, "circ_m": 1.43}]}, {"label": "Popular tyres", "items": [{"id": 5, "name": "Dunlop TT92GP 3.50-10 (137.3)", "circ_cm": 137.3, "circ_m": 1.3730000000000002}, {"id": 6, "name": "SAVA MC20 3.50-10 (135.0)", "circ_cm": 135.0, "circ_m": 1.35}, {"id": 7, "name": "Michelin S1 3.50-10 (136.2)", "circ_cm": 136.2, "circ_m": 1.3619999999999999}]}, {"label": "Custom tyres", "items": [{"id": 9, "name": "Custom 1 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 10, "name": "Custom 2 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 11, "name": "Custom 3 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 12, "name": "Custom 4 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 13, "name": "Custom 5 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 14, "name": "Custom 6 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 15, "name": "Custom 7 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 16, "name": "Custom 8 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 17, "name": "Custom 9 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 18, "name": "Custom 10 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 19, "name": "Custom 11 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 20, "name": "Custom 12 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 21, "name": "Custom 13 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 22, "name": "Custom 14 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 23, "name": "Custom 15 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 24, "name": "Custom 16 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 25, "name": "Custom 17 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 26, "name": "Custom 18 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 27, "name": "Custom 19 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}, {"id": 28, "name": "Custom 20 (0 cm)", "circ_cm": 0.0, "circ_m": 0.0}]}, {"label": "More tyres", "items": [{"id": 30, "name": "Schwalbe Classic 3.00-10 (127.7 cm)", "circ_cm": 127.7, "circ_m": 1.2770000000000001}, {"id": 31, "name": "Schwalbe Classic 3.50-10 (135.7 cm)", "circ_cm": 135.7, "circ_m": 1.357}, {"id": 32, "name": "Schwalbe Paceman 3.00-10 (127.7 cm)", "circ_cm": 127.7, "circ_m": 1.2770000000000001}, {"id": 33, "name": "Schwalbe Paceman 3.50-10 (135.7 cm)", "circ_cm": 135.7, "circ_m": 1.357}, {"id": 34, "name": "Schwalbe Powertrack 100/80-10 (130.1 cm)", "circ_cm": 130.1, "circ_m": 1.301}, {"id": 35, "name": "Schwalbe Powertrack 100/90-10 (136.4 cm)", "circ_cm": 136.4, "circ_m": 1.364}, {"id": 36, "name": "Schwalbe Powertrack 110/80-10 (135.1 cm)", "circ_cm": 135.1, "circ_m": 1.351}, {"id": 37, "name": "Schwalbe Powertrack 120/90-10 (147.7 cm)", "circ_cm": 147.7, "circ_m": 1.4769999999999999}, {"id": 38, "name": "Schwalbe Powertrack 130/70-10 (137.0 cm)", "circ_cm": 137.0, "circ_m": 1.37}, {"id": 39, "name": "Schwalbe Powertrack 130/90-10 (153.3 cm)", "circ_cm": 153.3, "circ_m": 1.5330000000000001}, {"id": 40, "name": "Schwalbe Powertrack 90/90-10 (130.7 cm)", "circ_cm": 130.7, "circ_m": 1.307}, {"id": 41, "name": "Schwalbe Raceman 100/80-10 (130.1 cm)", "circ_cm": 130.1, "circ_m": 1.301}, {"id": 42, "name": "Schwalbe Raceman 100/90-10 (136.4 cm)", "circ_cm": 136.4, "circ_m": 1.364}, {"id": 43, "name": "Schwalbe Raceman 110/80-10 (135.1 cm)", "circ_cm": 135.1, "circ_m": 1.351}, {"id": 44, "name": "Schwalbe Raceman 120/70-10 (132.6 cm)", "circ_cm": 132.6, "circ_m": 1.3259999999999998}, {"id": 45, "name": "Schwalbe Raceman 120/90-10 (147.7 cm)", "circ_cm": 147.7, "circ_m": 1.4769999999999999}, {"id": 46, "name": "Schwalbe Raceman 130/90-10 (153.3 cm)", "circ_cm": 153.3, "circ_m": 1.5330000000000001}, {"id": 47, "name": "Schwalbe Raceman 3.50-10 (135.7 cm)", "circ_cm": 135.7, "circ_m": 1.357}, {"id": 48, "name": "Schwalbe Raceman 90/90-10 (130.7 cm)", "circ_cm": 130.7, "circ_m": 1.307}, {"id": 49, "name": "Schwalbe Weatherman 100/80-10 (130.1 cm)", "circ_cm": 130.1, "circ_m": 1.301}, {"id": 50, "name": "Schwalbe Weatherman 100/90-10 (136.4 cm)", "circ_cm": 136.4, "circ_m": 1.364}, {"id": 51, "name": "Schwalbe Weatherman 110/80-10 (135.1 cm)", "circ_cm": 135.1, "circ_m": 1.351}, {"id": 52, "name": "Schwalbe Weatherman 120/70-10 (132.6 cm)", "circ_cm": 132.6, "circ_m": 1.3259999999999998}, {"id": 53, "name": "Schwalbe Weatherman 120/90-10 (147.7 cm)", "circ_cm": 147.7, "circ_m": 1.4769999999999999}, {"id": 54, "name": "Schwalbe Weatherman 130/70-10 (137.0 cm)", "circ_cm": 137.0, "circ_m": 1.37}, {"id": 55, "name": "Schwalbe Weatherman 130/90-10 (153.3 cm)", "circ_cm": 153.3, "circ_m": 1.5330000000000001}, {"id": 56, "name": "Schwalbe Weatherman 90/90-10 (130.7 cm)", "circ_cm": 130.7, "circ_m": 1.307}]}], "sprockets": [11, 12, 13, 14, 15, 16], "crowns": [45, 46, 47], "chainLookup": {"45": {"11": "73 link", "12": "No viable chain available for this combination", "13": "74 link", "14": "74 link", "15": "75 link", "16": "75 link"}, "46": {"11": "No viable chain available for this combination", "12": "74 link", "13": "Stretched 74 link", "14": "75 link", "15": "75 link", "16": "76 link"}, "47": {"11": "74 link", "12": "Stretched 74 link", "13": "75 link", "14": "No viable chain available for this combination", "15": "No viable chain available for this combination", "16": "76 link"}}}</script>
<script>
const DATA = JSON.parse(document.getElementById("DATA_JSON").textContent);

function firstGearboxId(){
  for (const g of (DATA.gearboxes || [])){
    for (const it of (g.items || [])){
      if (it && typeof it.id === "number") return it.id;
    }
  }
  return null;
}
function firstTyreId(){
  for (const g of (DATA.tyres || [])){
    for (const it of (g.items || [])){
      if (it && typeof it.id === "number") return it.id;
    }
  }
  return null;
}
function normalizeState(){
  // fill missing keys for older saved states
  state.unit = (state.unit === "mph" || state.unit === "kmh") ? state.unit : DEFAULTS.unit;
  state.speedStep = (isFinite(state.speedStep) && state.speedStep > 0) ? state.speedStep : DEFAULTS.speedStep;

  state.rpmIn = (isFinite(state.rpmIn) && state.rpmIn > 0) ? state.rpmIn : DEFAULTS.rpmIn;
  state.rpmPeak = (isFinite(state.rpmPeak) && state.rpmPeak > 0) ? state.rpmPeak : DEFAULTS.rpmPeak;
  state.rpmShift = (isFinite(state.rpmShift) && state.rpmShift > 0) ? state.rpmShift : DEFAULTS.rpmShift;
  state.rpmMax = (isFinite(state.rpmMax) && state.rpmMax > 0) ? state.rpmMax : DEFAULTS.rpmMax;
  state.rpmIdle = (isFinite(state.rpmIdle) && state.rpmIdle >= 0) ? state.rpmIdle : (DEFAULTS.rpmIdle || 1000);

  const fg = firstGearboxId();
  const ft = firstTyreId();

  state.gearboxA = isFinite(state.gearboxA) ? state.gearboxA : (DEFAULTS.gearboxA ?? fg);
  state.gearboxB = isFinite(state.gearboxB) ? state.gearboxB : (DEFAULTS.gearboxB ?? fg);

  state.tyreA = isFinite(state.tyreA) ? state.tyreA : (DEFAULTS.tyreA ?? ft);
  state.tyreB = isFinite(state.tyreB) ? state.tyreB : (DEFAULTS.tyreB ?? ft);

  state.sprocketA = isFinite(state.sprocketA) ? state.sprocketA : DEFAULTS.sprocketA;
  state.crownA = isFinite(state.crownA) ? state.crownA : DEFAULTS.crownA;
  state.sprocketB = isFinite(state.sprocketB) ? state.sprocketB : DEFAULTS.sprocketB;
  state.crownB = isFinite(state.crownB) ? state.crownB : DEFAULTS.crownB;

  state.rowHeightPct = (isFinite(state.rowHeightPct) && state.rowHeightPct >= 30 && state.rowHeightPct <= 140)
    ? state.rowHeightPct
    : 100;
}

const DEFAULTS = {"gearboxA": 9, "gearboxB": 5, "tyreA": 1, "tyreB": 1, "sprocketA": 14, "crownA": 46, "sprocketB": 13, "crownB": 46, "rpmIn": 3900, "rpmPeak": 6800, "rpmShift": 7500, "rpmMax": 8000, "unit": "kmh", "speedStep": 2, "rpmIdle": 1000};
const STORAGE_KEY = "lambretta_small_frame_visualiser_v1";

// -------- utils
const clamp = (v, a, b) => Math.min(b, Math.max(a, v));
const roundTo = (v, step) => Math.round(v/step)*step;
const ceilTo = (v, step) => Math.ceil(v/step)*step;

function ordinal(n){
  const mod100 = n % 100;
  const mod10 = n % 10;
  if (mod100 >= 10 && mod100 <= 20) return n + "th";
  return n + ({1:"st",2:"nd",3:"rd"}[mod10] || "th");
}

function hex(r,g,b){
  const to = (x)=>x.toString(16).padStart(2,"0");
  return "#" + to(r) + to(g) + to(b);
}

function luminance(r,g,b){
  // relative luminance approx
  return (0.2126*r + 0.7152*g + 0.0722*b)/255;
}

function colorForRPM(rpm, rpmIn, rpmPeak, rpmShift, rpmMax){
  if (!isFinite(rpm) || rpm<=0) return {bg:"#00000000", fg:"rgba(255,255,255,0.85)"};
  if (rpm <= rpmIn) return {bg: hex(217,217,217), fg:"#000"};

  // Green -> Yellow
  if (rpm <= rpmPeak){
    const t = (rpmPeak===rpmIn) ? 1 : (rpm - rpmIn)/(rpmPeak - rpmIn);
    const r = Math.round(0 + t*(255-0));
    const g = Math.round(176 + t*(255-176));
    const b = Math.round(80 + t*(0-80));
    const bg = hex(r,g,b);
    const fg = luminance(r,g,b) > 0.6 ? "#000" : "#fff";
    return {bg, fg};
  }

  // Yellow -> Orange
  if (rpm <= rpmShift){
    const t = (rpmShift===rpmPeak) ? 1 : (rpm - rpmPeak)/(rpmShift - rpmPeak);
    const r = 255;
    const g = Math.round(255 + t*(165-255));
    const b = 0;
    const bg = hex(r,g,b);
    const fg = luminance(r,g,b) > 0.6 ? "#000" : "#fff";
    return {bg, fg};
  }

  // Orange -> Red
  if (rpm <= rpmMax){
    const t = (rpmMax===rpmShift) ? 1 : (rpm - rpmShift)/(rpmMax - rpmShift);
    const r = 255;
    const g = Math.round(165 + t*(0-165));
    const b = 0;
    const bg = hex(r,g,b);
    const fg = luminance(r,g,b) > 0.6 ? "#000" : "#fff";
    return {bg, fg};
  }

  return {bg: hex(255,0,0), fg:"#fff"};
}

function unitLabel(unit){
  return unit === "kmh" ? "km/h" : "mph";
}

function toKmh(speed, unit){
  return unit==="kmh" ? speed : speed*1.609344;
}

function fromKmh(kmh, unit){
  return unit==="kmh" ? kmh : kmh/1.609344;
}

// -------- state
let state = null;

// -------- data helpers
function allGearboxesFlat(){
  const out = [];
  for (const g of DATA.gearboxes) {
    for (const it of g.items) out.push(it);
  }
  return out;
}

function findGearbox(id){
  for (const g of DATA.gearboxes) {
    for (const it of g.items) if (it.id === id) return it;
  }
  return null;
}

function allTyresFlat(){
  const out = [];
  for (const g of DATA.tyres) {
    for (const it of g.items) out.push(it);
  }
  return out;
}

function findTyre(id){
  for (const g of DATA.tyres) {
    for (const it of g.items) if (it.id === id) return it;
  }
  return null;
}

function validGearPairs(gearbox){
  const pairs = gearbox?.gears || [];
  return pairs.filter(p => p && p[0] && p[1] && p[0]>0 && p[1]>0);
}

function overallRatio(pair, sprocket, crown){
  const [driven, drive] = pair;
  if (!driven || !drive || !sprocket || !crown) return NaN;
  return (driven/drive) * (crown/sprocket);
}


function chainText(crown, sprocket){
  if (!crown || !sprocket) return "—";
  const row = DATA.chainLookup?.[crown];
  if (!row) return "Data unavailable";
  const v = row[sprocket];
  return v || "Data unavailable";
}

function fmt(x, digits=3){
  return (isFinite(x) ? x.toFixed(digits) : "—");
}

function renderSetupInfo(targetEl, tag, gb, tyre, sprocket, crown){
  if (!targetEl){
    return;
  }

  const tyreName = tyre?.name || "—";
  const tyreCirc = tyre?.circ_m;
  const primary = (crown && sprocket) ? (crown / sprocket) : NaN;
  const chain = chainText(crown, sprocket);

  const gbName = gb?.name || "—";
  const gbId = gb?.id ?? "—";
  const gbNote = gb?.note || "";
  const pairs = gb?.gears || [];

  // overall ratios for drop calculation (use only gears with valid pairs)
  const overall = pairs.map(p => (p && p[0] && p[1]) ? overallRatio(p, sprocket, crown) : NaN);

  function nextValidIndex(i){
    for (let j=i+1;j<overall.length;j++){
      if (isFinite(overall[j]) && overall[j]>0) return j;
    }
    return -1;
  }

  let rowsHtml = "";
  for (let i=0;i<pairs.length;i++){
    const p = pairs[i];
    if (!(p && p[0] && p[1])) continue;

    const gearNo = i+1;
    const teeth = `${p[0]}/${p[1]}`;
    const gearRatio = p[0]/p[1];
    const ovr = overall[i];

    const j = nextValidIndex(i);
    const drop = (j >= 0) ? (1 - (overall[j] / overall[i])) * 100 : NaN;

    rowsHtml += `
      <tr>
        <td>${ordinal(gearNo)}</td>
        <td>${teeth}</td>
        <td>${fmt(gearRatio,3)}</td>
        <td>${fmt(ovr,3)}</td>
        <td class="muted">${isFinite(drop) ? drop.toFixed(1) + "%" : "—"}</td>
      </tr>`;
  }

  targetEl.innerHTML = `
    <div class="kv">
      <div class="k">Gearbox</div><div><b>${gbName}</b> <span class="muted">(#${gbId})</span></div>
      ${gbNote ? `<div class="k">Note</div><div>${gbNote.replace(/\n/g,'<br>')}</div>` : ``}
      <div class="k">Tyre</div><div>${tyreName} <span class="muted">(${isFinite(tyreCirc)?tyreCirc.toFixed(3)+" m":"—"})</span></div>
      <div class="k">Primary ratio</div><div>${fmt(primary,3)} <span class="muted">(${crown}/${sprocket})</span></div>
      <div class="k">Chain</div><div>${chain}</div>
    </div>

    <div class="miniTableWrap"><table class="miniTable" aria-label="${tag} gearbox details">
      <thead>
        <tr>
          <th>Gear</th><th>Teeth</th><th>Gear</th><th>Overall</th><th>Drop</th>
        </tr>
      </thead>
      <tbody>
        ${rowsHtml || `<tr><td colspan="5" class="muted">No gearbox data</td></tr>`}
      </tbody>
    </table></div>
  `;
}

function speedKmhAtRPM(rpm, pair, tyreCircM, sprocket, crown){
  const ratio = overallRatio(pair, sprocket, crown);
  if (!isFinite(ratio) || ratio<=0) return NaN;
  if (!isFinite(tyreCircM) || tyreCircM<=0) return NaN;
  const wheelRpm = rpm/ratio;
  const mPerMin = wheelRpm * tyreCircM;
  return mPerMin * 60 / 1000;
}

function rpmAtSpeedKmh(kmh, pair, tyreCircM, sprocket, crown){
  const ratio = overallRatio(pair, sprocket, crown);
  if (!isFinite(ratio) || ratio<=0) return NaN;
  if (!isFinite(tyreCircM) || tyreCircM<=0) return NaN;
  const mPerMin = kmh * 1000 / 60;
  const wheelRpm = mPerMin / tyreCircM;
  return wheelRpm * ratio;
}

function maxSpeedForSetup(setup){
  const gb = findGearbox(setup.gearboxId);
  const tyre = findTyre(setup.tyreId);
  if (!gb || !tyre) return NaN;
  const pairs = gb.gears || [];
  let best = NaN;
  for (let i = pairs.length-1; i>=0; i--) {
    const p = pairs[i];
    if (!p || !p[0] || !p[1]) continue;
    const kmh = speedKmhAtRPM(state.rpmMax, p, tyre.circ_m, setup.sprocket, setup.crown);
    if (isFinite(kmh)) {
      best = kmh;
      break;
    }
  }
  return best;
}

// -------- UI
const els = {
  unit: document.getElementById("unit"),
  step: document.getElementById("step"),
  rowHeight: document.getElementById("rowHeight"),
  rowHeightLabel: document.getElementById("rowHeightLabel"),
  rhMinus: document.getElementById("rhMinus"),
  rhPlus: document.getElementById("rhPlus"),
  fit: document.getElementById("fit"),
  save: document.getElementById("save"),
  load: document.getElementById("load"),
  reset: document.getElementById("reset"),

  rpmIn: document.getElementById("rpmIn"),
  rpmPeak: document.getElementById("rpmPeak"),
  rpmShift: document.getElementById("rpmShift"),
  rpmMax: document.getElementById("rpmMax"),
  rpmIdle: document.getElementById("rpmIdle"),

  gbA: document.getElementById("gbA"),
  gbB: document.getElementById("gbB"),
  tyreA: document.getElementById("tyreA"),
  tyreB: document.getElementById("tyreB"),
  sprA: document.getElementById("sprA"),
  cwA: document.getElementById("cwA"),
  sprB: document.getElementById("sprB"),
  cwB: document.getElementById("cwB"),

  sprList: document.getElementById("sprList"),
  cwList: document.getElementById("cwList"),

  infoA: document.getElementById("infoA"),
  infoB: document.getElementById("infoB"),
  tbody: document.getElementById("tbody"),
  speedHead: document.getElementById("speedHead"),
  tableWrap: document.getElementById("tableWrap"),

  maxA: document.getElementById("maxA"),
  maxB: document.getElementById("maxB"),
  maxAuto: document.getElementById("maxAuto"),
};

function populateSelect(selectEl, groups, selectedId){
  selectEl.innerHTML = "";
  for (const g of groups) {
    const og = document.createElement("optgroup");
    og.label = g.label;
    for (const it of g.items) {
      const opt = document.createElement("option");
      opt.value = it.id;
      opt.textContent = it.name;
      if (it.id === selectedId) opt.selected = true;
      og.appendChild(opt);
    }
    selectEl.appendChild(og);
  }
}

function populateTyres(selectEl, tyreGroups, selectedId){
  selectEl.innerHTML="";
  for (const g of tyreGroups) {
    const og=document.createElement("optgroup");
    og.label=g.label;
    for (const it of g.items) {
      const opt=document.createElement("option");
      opt.value=it.id;
      const cm = (it.circ_cm!=null) ? it.circ_cm.toFixed(1) : "—";
      opt.textContent = `${it.name} (${cm} cm)`;
      if (it.id===selectedId) opt.selected=true;
      og.appendChild(opt);
    }
    selectEl.appendChild(og);
  }
}

function populateDatalists(){
  // sprockets/crowns from sheet-derived tables
  const sprVals = (DATA.sprockets || []).filter(x=>x>=10);
  const cwVals = (DATA.crowns || []);
  els.sprList.innerHTML = sprVals.map(v=>`<option value="${v}"></option>`).join("");
  els.cwList.innerHTML = cwVals.map(v=>`<option value="${v}"></option>`).join("");
}

function setRowHeightPercent(p){
  const pct = clamp(Math.round(p), 40, 140);
  els.rowHeight.value = String(pct);
  els.rowHeightLabel.textContent = pct + "%";
  const base = 34; // px
  const px = Math.round(base * (pct/100));
  document.documentElement.style.setProperty("--rowH", px + "px");
  state.rowHeightPct = pct;
}

function fitTableToScreen(){
  // Try to fit all rows (plus header) within viewport height by adjusting row height.
  const wrap = els.tableWrap;
  const tbl = document.getElementById("tbl");
  const headerH = tbl.tHead ? tbl.tHead.getBoundingClientRect().height : 70;
  const avail = Math.max(220, window.innerHeight - wrap.getBoundingClientRect().top - 30);
  const rows = els.tbody.children.length || 1;
  const rowH = Math.floor((avail - headerH) / rows);
  const base = 34;
  const pct = clamp((rowH / base) * 100, 40, 140);
  setRowHeightPercent(pct);
}

function readStateFromUI(){
  state.unit = els.unit.value;
  state.speedStep = parseFloat(els.step.value) || 2;

  state.rpmIn = parseInt(els.rpmIn.value || "0", 10);
  state.rpmPeak = parseInt(els.rpmPeak.value || "0", 10);
  state.rpmShift = parseInt(els.rpmShift.value || "0", 10);
  state.rpmMax = parseInt(els.rpmMax.value || "0", 10);
  state.rpmIdle = parseInt(els.rpmIdle.value || "0", 10);

  state.A.gearboxId = parseInt(els.gbA.value, 10);
  state.B.gearboxId = parseInt(els.gbB.value, 10);
  state.A.tyreId = parseInt(els.tyreA.value, 10);
  state.B.tyreId = parseInt(els.tyreB.value, 10);

  state.A.sprocket = parseInt(els.sprA.value || "0", 10);
  state.A.crown = parseInt(els.cwA.value || "0", 10);
  state.B.sprocket = parseInt(els.sprB.value || "0", 10);
  state.B.crown = parseInt(els.cwB.value || "0", 10);
}

function writeStateToUI(){
  els.unit.value = state.unit;
  els.step.value = state.speedStep;

  els.rpmIn.value = state.rpmIn;
  els.rpmPeak.value = state.rpmPeak;
  els.rpmShift.value = state.rpmShift;
  els.rpmMax.value = state.rpmMax;
  els.rpmIdle.value = state.rpmIdle;

  populateSelect(els.gbA, DATA.gearboxes, state.A.gearboxId);
  populateSelect(els.gbB, DATA.gearboxes, state.B.gearboxId);
  populateTyres(els.tyreA, DATA.tyres, state.A.tyreId);
  populateTyres(els.tyreB, DATA.tyres, state.B.tyreId);

  els.sprA.value = state.A.sprocket;
  els.cwA.value = state.A.crown;
  els.sprB.value = state.B.sprocket;
  els.cwB.value = state.B.crown;

  setRowHeightPercent(state.rowHeightPct ?? 100);
  els.speedHead.textContent = unitLabel(state.unit);
}

function buildRows(){
  // determine max speed based on max rpm and top gear in each setup
  const maxAKmh = maxSpeedForSetup(state.A);
  const maxBKmh = maxSpeedForSetup(state.B);
  const maxA = fromKmh(maxAKmh, state.unit);
  const maxB = fromKmh(maxBKmh, state.unit);
  const maxAuto = Math.max(isFinite(maxA)?maxA:0, isFinite(maxB)?maxB:0);

  els.maxA.textContent = `A max @ max rpm: ${isFinite(maxA) ? maxA.toFixed(1) : "—"} ${unitLabel(state.unit)}`;
  els.maxB.textContent = `B max @ max rpm: ${isFinite(maxB) ? maxB.toFixed(1) : "—"} ${unitLabel(state.unit)}`;
  els.maxAuto.textContent = `Auto max speed: ${isFinite(maxAuto) ? ceilTo(maxAuto, state.speedStep).toFixed(1) : "—"} ${unitLabel(state.unit)}`;

  const top = isFinite(maxAuto) && maxAuto>0 ? ceilTo(maxAuto, state.speedStep) : 80;
  const speeds = [];
  for (let s = top; s >= 0; s = Math.max(0, +(s - state.speedStep).toFixed(6))) {
    speeds.push(s);
    if (s===0) break;
  }
  return speeds;
}

function renderTable(){
  readStateFromUI();
  els.speedHead.textContent = unitLabel(state.unit);

  const speeds = buildRows();
  const gbA = findGearbox(state.A.gearboxId);
  const gbB = findGearbox(state.B.gearboxId);
  const tyreA = findTyre(state.A.tyreId);
  const tyreB = findTyre(state.B.tyreId);

  const pairsA = gbA?.gears || [];
  const pairsB = gbB?.gears || [];

  // extra info panels (gearbox data + chain length)
  renderSetupInfo(els.infoA, "A", gbA, tyreA, state.A.sprocket, state.A.crown);
  renderSetupInfo(els.infoB, "B", gbB, tyreB, state.B.sprocket, state.B.crown);

  els.tbody.innerHTML = "";
  for (const s of speeds) {
    const tr = document.createElement("tr");

    const kmh = toKmh(s, state.unit);

    // setup A cells
    for (let gi=0; gi<5; gi++) {
      const td = document.createElement("td");
      td.className = "rpm";
      const p = pairsA[gi];
      const rpm = (p && p[0] && p[1] && tyreA) ? rpmAtSpeedKmh(kmh, p, tyreA.circ_m, state.A.sprocket, state.A.crown) : NaN;
      if (isFinite(rpm) && rpm >= state.rpmIdle && rpm <= state.rpmMax) {
        const r = (rpm >= 200) ? (Math.round(rpm/10)*10) : Math.round(rpm);
        td.textContent = String(r);
        const c = colorForRPM(rpm, state.rpmIn, state.rpmPeak, state.rpmShift, state.rpmMax);
        td.style.background = c.bg;
        td.style.color = c.fg;
      } else {
        td.textContent = "";
        td.style.background = "rgba(0,0,0,0.18)";
        td.style.color = "rgba(255,255,255,0.85)";
      }
      tr.appendChild(td);
    }

    // speed cell
    const tdS = document.createElement("td");
    tdS.className = "speed";
    tdS.textContent = s % 1 === 0 ? String(s.toFixed(0)) : String(s.toFixed(1));
    tr.appendChild(tdS);

    // setup B cells
    for (let gi=0; gi<5; gi++) {
      const td = document.createElement("td");
      td.className = "rpm";
      const p = pairsB[gi];
      const rpm = (p && p[0] && p[1] && tyreB) ? rpmAtSpeedKmh(kmh, p, tyreB.circ_m, state.B.sprocket, state.B.crown) : NaN;
      if (isFinite(rpm) && rpm >= state.rpmIdle && rpm <= state.rpmMax) {
        const r = (rpm >= 200) ? (Math.round(rpm/10)*10) : Math.round(rpm);
        td.textContent = String(r);
        const c = colorForRPM(rpm, state.rpmIn, state.rpmPeak, state.rpmShift, state.rpmMax);
        td.style.background = c.bg;
        td.style.color = c.fg;
      } else {
        td.textContent = "";
        td.style.background = "rgba(0,0,0,0.18)";
        td.style.color = "rgba(255,255,255,0.85)";
      }
      tr.appendChild(td);
    }

    els.tbody.appendChild(tr);
  }
}

function saveState(){
  readStateFromUI();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return false;
  try {
    const obj = JSON.parse(raw);
    if (!obj) return false;
    state = obj;
    // ensure required keys exist
    state.A = state.A || {};
    state.B = state.B || {};
    state.rowHeightPct = state.rowHeightPct ?? 100;
    normalizeState();
  writeStateToUI();
    renderTable();
    return true;
  } catch(e) {
    return false;
  }
}

function resetState(){
  state = {
    unit: DEFAULTS.unit || "mph",
    speedStep: DEFAULTS.speedStep || 2,
    rpmIn: DEFAULTS.rpmIn,
    rpmPeak: DEFAULTS.rpmPeak,
    rpmShift: DEFAULTS.rpmShift,
    rpmMax: DEFAULTS.rpmMax,
    rpmIdle: (DEFAULTS.rpmIdle || 1000),
    rowHeightPct: 100,
    A: {
      gearboxId: DEFAULTS.gearboxA,
      tyreId: DEFAULTS.tyreA,
      sprocket: DEFAULTS.sprocketA,
      crown: DEFAULTS.crownA
    },
    B: {
      gearboxId: DEFAULTS.gearboxB,
      tyreId: DEFAULTS.tyreB,
      sprocket: DEFAULTS.sprocketB,
      crown: DEFAULTS.crownB
    }
  };
  writeStateToUI();
  renderTable();
}

function init(){
  populateDatalists();
  resetState();
  loadState(); // if exists, it will override

  // listeners
  const rerender = ()=>{ renderTable(); };
  ["change","input"].forEach(evt=>{
    els.unit.addEventListener(evt, ()=>{
      // convert step to match new unit, keep roughly same increment in km/h
      const prev = state.unit;
      readStateFromUI();
      const stepVal = state.speedStep;
      // when user toggles units, convert current step numeric to new unit
      // If prev differs, convert
      if (prev !== els.unit.value) {
        const stepKmh = prev==="kmh" ? stepVal : stepVal*1.609344;
        const newStep = els.unit.value==="kmh" ? stepKmh : stepKmh/1.609344;
        els.step.value = (Math.round(newStep*2)/2).toString(); // nearest 0.5
      }
      renderTable();
    });
    els.step.addEventListener(evt, rerender);
    els.rpmIn.addEventListener(evt, rerender);
    els.rpmPeak.addEventListener(evt, rerender);
    els.rpmShift.addEventListener(evt, rerender);
    els.rpmMax.addEventListener(evt, rerender);
    els.rpmIdle.addEventListener(evt, rerender);

    els.gbA.addEventListener(evt, rerender);
    els.gbB.addEventListener(evt, rerender);
    els.tyreA.addEventListener(evt, rerender);
    els.tyreB.addEventListener(evt, rerender);
    els.sprA.addEventListener(evt, rerender);
    els.cwA.addEventListener(evt, rerender);
    els.sprB.addEventListener(evt, rerender);
    els.cwB.addEventListener(evt, rerender);
  });

  els.rowHeight.addEventListener("input", ()=> setRowHeightPercent(parseInt(els.rowHeight.value,10)));
  els.rhMinus.addEventListener("click", ()=> setRowHeightPercent((state.rowHeightPct||100) - 5));
  els.rhPlus.addEventListener("click", ()=> setRowHeightPercent((state.rowHeightPct||100) + 5));
  els.fit.addEventListener("click", ()=>{ fitTableToScreen(); });
  window.addEventListener("resize", ()=>{ /* keep current */ });

  els.save.addEventListener("click", saveState);
  els.load.addEventListener("click", ()=>{ loadState(); });
  els.reset.addEventListener("click", ()=>{ localStorage.removeItem(STORAGE_KEY); resetState(); });
}

try { init(); } catch (e) {
  console.error(e);
  const b = document.getElementById('errorBanner');
  if (b) { b.style.display='block'; b.textContent = 'Script error: ' + (e && e.message ? e.message : String(e)); }
}
</script>
</body>
</html>
