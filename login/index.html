<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Login — Innovatio Brutalis</title>

  <link rel="canonical" href="https://www.innovatio-brutalis.se/login/">
  <link rel="stylesheet" href="/css/style.css">

  <meta name="ib-topbar-cta-label" content="Kontakt">
  <meta name="ib-topbar-cta-href" content="/#kontakt">

  <!-- Turnstile site key should be provided via meta tag -->
  <meta name="ib-turnstile-sitekey" content="0x4AAAAAAChDtETbf_hp3tmL">
</head>
<body>
  <div class="container">
    <div id="site-topbar"></div>
    <script defer src="/assets/site.js"></script>
    <script defer src="/assets/site-deeplinks.js"></script>

    <main>
      <section class="card">
        <h1>Logga in</h1>
        <p>Vi använder magic link (ingen lösenordshantering).</p>

        <label style="display:block; margin-top:14px">
          E-post
          <input id="email" type="email" autocomplete="email" placeholder="din@epost.se" style="width:100%; margin-top:8px">
        </label>

        <div style="margin-top:14px">
          <div id="turnstile"></div>
        </div>

        <button id="send" class="btn" style="margin-top:14px">Skicka login-länk</button>
        <div id="status" style="margin-top:12px; color: var(--text-muted)"></div>

        <div id="dev" style="margin-top:10px"></div>
      </section>
    </main>

    <script type="module">
      import { apiPost } from '/assets/js/api.js';
      import { ensureShell, renderFooter, setStatus } from '/assets/js/ui.js';

      const LAST_EMAIL_KEY = 'ib_last_login_email_v1';

      // Avoid Turnstile domain mismatch by always using the canonical hostname.
      try {
        if (location.hostname === 'innovatio-brutalis.se') {
          location.replace(`https://www.innovatio-brutalis.se${location.pathname}${location.search}${location.hash}`);
        }
      } catch (_) {}

      ensureShell({ activeSection: '' });
      renderFooter();

      const emailEl = document.getElementById('email');
      const btn = document.getElementById('send');
      const statusEl = document.getElementById('status');
      const devEl = document.getElementById('dev');
      const turnstileMount = document.getElementById('turnstile');

      const siteKey = document.querySelector('meta[name="ib-turnstile-sitekey"]')?.getAttribute('content')?.trim();
      let turnstileToken = '';
      let turnstileWidgetId = null;
      let turnstileScriptLoaded = false;
      let turnstileScriptErrored = false;

      const isEmail = (s) => {
        const t = String(s || '').trim().toLowerCase();
        if (!t || t.length > 320) return false;
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t);
      };

      // Prefill last used email (best-effort)
      try {
        const last = String(localStorage.getItem(LAST_EMAIL_KEY) || '').trim();
        if (last && emailEl && !emailEl.value) emailEl.value = last;
      } catch (_) {}

      const updateBtnState = () => {
        // Turnstile is best-effort. Only require a valid email to request a link.
        const ok = isEmail(emailEl?.value);
        btn.disabled = !ok;
      };

      const getTurnstileApi = () => {
        const t = window.turnstile;
        if (!t) return null;
        if (typeof t.render !== 'function') return null;
        return t;
      };

      const mountTurnstile = () => {
        if (!siteKey) {
          setStatus(statusEl, 'Turnstile site key saknas (ib-turnstile-sitekey).', 'warn');
          return false;
        }
        if (!turnstileMount) return;
        const t = getTurnstileApi();
        if (!t) {
          setStatus(statusEl, 'Laddar verifiering…', 'info');
          return false;
        }
        if (turnstileWidgetId !== null) return true;
        const id = t.render(turnstileMount, {
          sitekey: siteKey,
          callback: (t) => {
            turnstileToken = String(t || '');
            updateBtnState();
          },
          'expired-callback': () => {
            turnstileToken = '';
            updateBtnState();
          },
          'error-callback': () => {
            turnstileToken = '';
            setStatus(statusEl, 'Turnstile gav ett fel. Prova att ladda om sidan och kontrollera adblock/brandvägg.', 'warn');
            updateBtnState();
          },
        });
        // render() returns a widget id (number). If it doesn't, use a sentinel.
        turnstileWidgetId = typeof id === 'number' ? id : 0;
        return true;
      };

      const ensureTurnstileMounted = () => {
        // Turnstile sometimes becomes available slightly after script onload.
        let attempts = 0;
        const tick = () => {
          attempts += 1;
          if (turnstileToken) {
            updateBtnState();
            return;
          }
          if (getTurnstileApi() && turnstileMount && turnstileWidgetId === null) {
            try {
              const ok = mountTurnstile();
              if (ok) return;
            } catch (_) {
              // If render failed, allow retry.
              turnstileWidgetId = null;
            }
          }

          if (attempts < 50) {
            setTimeout(tick, 100);
            return;
          }

          // After ~5s, show a clear hint.
          if (!turnstileToken) {
            // Keep this non-blocking: login should still work.
            if (turnstileScriptErrored || !turnstileScriptLoaded) {
              setStatus(statusEl, 'Verifiering kunde inte laddas, men du kan fortfarande begära en login-länk.', 'info');
              return;
            }
            setStatus(statusEl, 'Verifiering laddade men startade inte. Du kan ändå begära en login-länk.', 'info');
          }
        };
        tick();
      };

      // Load Turnstile
      const scriptUrl = 'https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit';
      const existing = Array.from(document.scripts || []).find((x) => {
        try {
          const src = String(x?.src || '');
          return src.includes('challenges.cloudflare.com/turnstile/v0/api.js');
        } catch (_) {
          return false;
        }
      });

      if (!existing) {
        const s = document.createElement('script');
        s.src = scriptUrl;
        s.async = true;
        s.defer = true;
        s.onload = () => {
          turnstileScriptLoaded = true;
          mountTurnstile();
          ensureTurnstileMounted();
        };
        s.onerror = () => {
          turnstileScriptErrored = true;
          setStatus(statusEl, 'Kunde inte ladda Turnstile. Prova att stänga av adblock/”tracking protection” och ladda om.', 'warn');
        };
        document.head.appendChild(s);
      } else {
        // Avoid loading Turnstile multiple times; just wait for API to be ready.
        turnstileScriptLoaded = true;
      }

      // Try mounting even if onload fires before Turnstile is fully ready.
      ensureTurnstileMounted();

      // Only enable when we have both a valid email and a Turnstile token.
      updateBtnState();
      emailEl?.addEventListener('input', () => {
        updateBtnState();
        try {
          const v = String(emailEl?.value || '').trim();
          if (v) localStorage.setItem(LAST_EMAIL_KEY, v);
        } catch (_) {}
      });

      btn.addEventListener('click', async () => {
        try {
          if (!isEmail(emailEl.value)) {
            setStatus(statusEl, 'Skriv in en giltig e-postadress.', 'warn');
            updateBtnState();
            return;
          }

          btn.disabled = true;
          setStatus(statusEl, 'Skickar…');
          devEl.innerHTML = '';

          let returnPath = '';
          try {
            const params = new URLSearchParams(window.location.search || '');
            returnPath = String(params.get('return') || '').trim();
          } catch (_) {}

          const data = await apiPost('/api/auth/request-link', {
            email: emailEl.value,
            turnstileToken,
            returnPath,
          });

          try {
            const v = String(emailEl?.value || '').trim();
            if (v) localStorage.setItem(LAST_EMAIL_KEY, v);
          } catch (_) {}
          setStatus(statusEl, 'Kolla din e-post för en login-länk.');
          if (data && data.debug_link) {
            devEl.innerHTML = `<a href="${data.debug_link}">DEV: öppna login-länken</a>`;
          }
        } catch (err) {
          // UI should remain generic.
          setStatus(statusEl, 'Kolla din e-post för en login-länk.');
        } finally {
          updateBtnState();
        }
      });
    </script>
  </div>
</body>
</html>
