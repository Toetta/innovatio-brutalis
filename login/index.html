<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Login — Innovatio Brutalis</title>

  <link rel="canonical" href="https://www.innovatio-brutalis.se/login/">
  <link rel="stylesheet" href="/css/style.css">

  <meta name="ib-topbar-cta-label" content="Kontakt">
  <meta name="ib-topbar-cta-href" content="/#kontakt">

  <!-- Turnstile site key should be provided via meta tag -->
  <meta name="ib-turnstile-sitekey" content="0x4AAAAAAChDtETbf_hp3tmL">
</head>
<body>
  <div class="container">
    <div id="site-topbar"></div>
    <script defer src="/assets/site.js"></script>
    <script defer src="/assets/site-deeplinks.js"></script>

    <main>
      <section class="card">
        <h1>Logga in</h1>
        <p>Vi använder magic link (ingen lösenordshantering).</p>

        <label style="display:block; margin-top:14px">
          E-post
          <input id="email" type="email" autocomplete="email" placeholder="din@epost.se" style="width:100%; margin-top:8px">
        </label>

        <div style="margin-top:14px">
          <div id="turnstile"></div>
        </div>

        <button id="send" class="btn" style="margin-top:14px">Skicka login-länk</button>
        <div id="status" style="margin-top:12px; color: var(--text-muted)"></div>

        <div id="dev" style="margin-top:10px"></div>
      </section>
    </main>

    <script type="module">
      import { apiPost } from '/assets/js/api.js';
      import { ensureShell, renderFooter, setStatus } from '/assets/js/ui.js';

      // Avoid Turnstile domain mismatch by always using the canonical hostname.
      try {
        if (location.hostname === 'innovatio-brutalis.se') {
          location.replace(`https://www.innovatio-brutalis.se${location.pathname}${location.search}${location.hash}`);
        }
      } catch (_) {}

      ensureShell({ activeSection: '' });
      renderFooter();

      const emailEl = document.getElementById('email');
      const btn = document.getElementById('send');
      const statusEl = document.getElementById('status');
      const devEl = document.getElementById('dev');
      const turnstileMount = document.getElementById('turnstile');

      const siteKey = document.querySelector('meta[name="ib-turnstile-sitekey"]')?.getAttribute('content')?.trim();
      let turnstileToken = '';
      let turnstileWidgetId = null;
      let turnstileScriptLoaded = false;
      let turnstileScriptErrored = false;

      const isEmail = (s) => {
        const t = String(s || '').trim().toLowerCase();
        if (!t || t.length > 320) return false;
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t);
      };

      const updateBtnState = () => {
        const ok = isEmail(emailEl?.value) && Boolean(turnstileToken);
        btn.disabled = !ok;
      };

      const mountTurnstile = () => {
        if (!siteKey) {
          setStatus(statusEl, 'Turnstile site key saknas (ib-turnstile-sitekey).', 'warn');
          return false;
        }
        if (!turnstileMount) return;
        if (!window.turnstile) {
          setStatus(statusEl, 'Laddar verifiering…', 'info');
          return false;
        }
        if (turnstileWidgetId !== null) return true;
        window.turnstile.render(turnstileMount, {
          sitekey: siteKey,
          callback: (t) => {
            turnstileToken = String(t || '');
            updateBtnState();
          },
          'expired-callback': () => {
            turnstileToken = '';
            updateBtnState();
          },
          'error-callback': () => {
            turnstileToken = '';
            setStatus(statusEl, 'Turnstile gav ett fel. Prova att ladda om sidan och kontrollera adblock/brandvägg.', 'warn');
            updateBtnState();
          },
        });
        // render() returns a widget id, but not all versions consistently do.
        // We treat "attempted render" as mounted to avoid repeated renders.
        try { turnstileWidgetId = 0; } catch (_) {}
        return true;
      };

      const ensureTurnstileMounted = () => {
        // Turnstile sometimes becomes available slightly after script onload.
        let attempts = 0;
        const tick = () => {
          attempts += 1;
          if (turnstileToken) {
            updateBtnState();
            return;
          }
          if (window.turnstile && turnstileMount && turnstileWidgetId === null) {
            try {
              const ok = mountTurnstile();
              if (ok) return;
            } catch (_) {
              // If render failed, allow retry.
              turnstileWidgetId = null;
            }
          }

          if (attempts < 50) {
            setTimeout(tick, 100);
            return;
          }

          // After ~5s, show a clear hint.
          if (!turnstileToken) {
            const scriptUrl = 'https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit';
            if (turnstileScriptErrored) {
              setStatus(statusEl, `Kunde inte ladda Turnstile (${scriptUrl}). Något blockerar anropet (nätverk/DNS/brandvägg).`, 'warn');
              return;
            }
            if (!turnstileScriptLoaded) {
              setStatus(statusEl, `Turnstile laddade inte (${scriptUrl}). Blockeras ofta av tracking protection eller DNS-filter.`, 'warn');
              return;
            }
            setStatus(statusEl, 'Turnstile laddade men startade inte. Prova slå av “tracking protection”/Brave Shields och tillåt tredjepartsskript för sidan.', 'warn');
          }
        };
        tick();
      };

      // Load Turnstile
      const s = document.createElement('script');
      s.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit';
      s.async = true;
      s.defer = true;
      s.onload = () => {
        turnstileScriptLoaded = true;
        mountTurnstile();
        ensureTurnstileMounted();
      };
      s.onerror = () => {
        turnstileScriptErrored = true;
        setStatus(statusEl, 'Kunde inte ladda Turnstile. Prova att stänga av adblock/”tracking protection” och ladda om.', 'warn');
      };
      document.head.appendChild(s);

      // Try mounting even if onload fires before Turnstile is fully ready.
      ensureTurnstileMounted();

      // Only enable when we have both a valid email and a Turnstile token.
      updateBtnState();
      emailEl?.addEventListener('input', updateBtnState);

      btn.addEventListener('click', async () => {
        try {
          if (!isEmail(emailEl.value)) {
            setStatus(statusEl, 'Skriv in en giltig e-postadress.', 'warn');
            updateBtnState();
            return;
          }
          if (!turnstileToken) {
            setStatus(statusEl, 'Verifiera att du inte är en robot (Turnstile).', 'warn');
            updateBtnState();
            return;
          }

          btn.disabled = true;
          setStatus(statusEl, 'Skickar…');
          devEl.innerHTML = '';

          let returnPath = '';
          try {
            const params = new URLSearchParams(window.location.search || '');
            returnPath = String(params.get('return') || '').trim();
          } catch (_) {}

          const data = await apiPost('/api/auth/request-link', {
            email: emailEl.value,
            turnstileToken,
            returnPath,
          });
          setStatus(statusEl, 'Kolla din e-post för en login-länk.');
          if (data && data.debug_link) {
            devEl.innerHTML = `<a href="${data.debug_link}">DEV: öppna login-länken</a>`;
          }
        } catch (err) {
          // UI should remain generic.
          setStatus(statusEl, 'Kolla din e-post för en login-länk.');
        } finally {
          updateBtnState();
        }
      });
    </script>
  </div>
</body>
</html>
