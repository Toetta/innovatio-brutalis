<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Account — Innovatio Brutalis</title>

  <link rel="canonical" href="https://www.innovatio-brutalis.se/account/">
  <link rel="stylesheet" href="/css/style.css">

  <meta name="ib-topbar-cta-label" content="Webshop">
  <meta name="ib-topbar-cta-href" content="/shop/">
</head>
<body>
  <div class="container">
    <div id="site-topbar"></div>
    <script defer src="/assets/site.js"></script>
    <script defer src="/assets/site-deeplinks.js"></script>

    <main>
      <section class="card">
        <h1>Mitt konto</h1>
        <p id="who" style="color:var(--text-muted)"></p>

        <div style="display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px">
          <label>
            Namn
            <input id="full_name" type="text" style="width:100%">
          </label>
          <label>
            Telefon
            <input id="phone" type="tel" style="width:100%">
          </label>
          <label>
            Företag
            <input id="company_name" type="text" style="width:100%">
          </label>
          <label>
            Org.nr
            <input id="orgnr" type="text" style="width:100%">
          </label>
          <label>
            VAT ID
            <input id="vat_id" type="text" style="width:100%">
          </label>
          <label style="display:flex; gap:10px; align-items:center">
            <input id="marketing_opt_in" type="checkbox">
            <span>Jag vill få uppdateringar via e-post</span>
          </label>
        </div>

        <button id="save" class="btn" style="margin-top:14px">Spara profil</button>
        <div id="status" style="margin-top:10px; color:var(--text-muted)"></div>
      </section>

      <section class="card" style="margin-top:18px">
        <h2>Adresser</h2>

        <div style="display:grid; grid-template-columns:1fr; gap:16px; margin-top:14px">
          <div>
            <h3>Faktura</h3>
            <div class="addr-grid">
              <div class="addr-fields">
                <label>Adressrad 1<input id="b_line1" type="text" style="width:100%"></label>
                <label>Adressrad 2<input id="b_line2" type="text" style="width:100%"></label>
                <label>Postnr<input id="b_postal_code" type="text" style="width:100%"></label>
                <label>Stad<input id="b_city" type="text" style="width:100%"></label>
                <label>Region<input id="b_region" type="text" style="width:100%"></label>
                <label>Land<input id="b_country" type="text" style="width:100%" value="SE"></label>
              </div>

              <aside class="addr-preview" aria-label="Förhandsvisning fakturaadress">
                <div class="addr-preview-title">Förhandsvisning</div>
                <div id="b_preview" class="addr-preview-box"></div>
                <small>Namn, företag, telefon och e-post hämtas från profilen ovan.</small>
              </aside>
            </div>
          </div>

          <div>
            <h3>Leverans <small>(inkl. namn)</small></h3>
            <div class="addr-grid">
              <div class="addr-fields">
                <label>Adressrad 1<input id="s_line1" type="text" style="width:100%"></label>
                <label>Adressrad 2<input id="s_line2" type="text" style="width:100%"></label>
                <label>Postnr<input id="s_postal_code" type="text" style="width:100%"></label>
                <label>Stad<input id="s_city" type="text" style="width:100%"></label>
                <label>Region<input id="s_region" type="text" style="width:100%"></label>
                <label>Land<input id="s_country" type="text" style="width:100%" value="SE"></label>
              </div>

              <aside class="addr-preview" aria-label="Förhandsvisning leveransadress">
                <div class="addr-preview-title">Förhandsvisning</div>
                <div id="s_preview" class="addr-preview-box"></div>
                <small>Leveransadressen använder ditt namn och dina kontaktuppgifter från profilen ovan.</small>
              </aside>
            </div>
          </div>
        </div>

        <button id="saveAddr" class="btn" style="margin-top:14px">Spara adresser</button>
        <div id="status2" style="margin-top:10px; color:var(--text-muted)"></div>
      </section>

      <section class="card" style="margin-top:18px">
        <h2>Session</h2>
        <a href="/orders/" class="btn">Mina ordrar</a>
        <button id="logout" class="btn" style="margin-left:10px">Logga ut</button>
      </section>
    </main>

    <script type="module">
      import { apiGet, apiPut, apiPost } from '/assets/js/api.js';
      import { ensureShell, renderFooter, setStatus } from '/assets/js/ui.js';

      ensureShell({ activeSection: '' });
      renderFooter();

      const who = document.getElementById('who');
      const statusEl = document.getElementById('status');
      const status2El = document.getElementById('status2');

      const bPreview = document.getElementById('b_preview');
      const sPreview = document.getElementById('s_preview');

      const get = (id) => document.getElementById(id);

      const fillAddr = (type, row) => {
        if (!row) return;
        const pre = type === 'billing' ? 'b_' : 's_';
        get(pre+'line1').value = row.line1 || '';
        get(pre+'line2').value = row.line2 || '';
        get(pre+'postal_code').value = row.postal_code || '';
        get(pre+'city').value = row.city || '';
        get(pre+'region').value = row.region || '';
        get(pre+'country').value = row.country || '';
      };

      const esc = (s) => String(s ?? '').replace(/[&<>"]/g, (ch) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;'
      }[ch]));

      const getProfileLines = () => {
        const lines = [];
        const fullName = String(get('full_name')?.value || '').trim();
        const company = String(get('company_name')?.value || '').trim();
        const phone = String(get('phone')?.value || '').trim();
        const email = String(who?.textContent || '').trim();
        if (fullName) lines.push(fullName);
        if (company) lines.push(company);
        // Keep contact info visible so users understand what “comes with” the address.
        if (phone) lines.push(`Tel: ${phone}`);
        if (email) lines.push(`E-post: ${email}`);
        return lines;
      };

      const getAddressLines = (prefix) => {
        const line1 = String(get(prefix+'line1')?.value || '').trim();
        const line2 = String(get(prefix+'line2')?.value || '').trim();
        const postal = String(get(prefix+'postal_code')?.value || '').trim();
        const city = String(get(prefix+'city')?.value || '').trim();
        const region = String(get(prefix+'region')?.value || '').trim();
        const country = String(get(prefix+'country')?.value || '').trim();

        const lines = [];
        if (line1) lines.push(line1);
        if (line2) lines.push(line2);
        const pcCity = [postal, city].filter(Boolean).join(' ');
        if (pcCity) lines.push(pcCity);
        if (region) lines.push(region);
        if (country) lines.push(country);
        return lines;
      };

      const renderPreviews = () => {
        try {
          if (bPreview) {
            const lines = [...getProfileLines(), ...getAddressLines('b_')].filter(Boolean);
            bPreview.innerHTML = esc(lines.join('\n'));
          }
        } catch (_) {}

        try {
          if (sPreview) {
            const lines = [...getProfileLines(), ...getAddressLines('s_')].filter(Boolean);
            sPreview.innerHTML = esc(lines.join('\n'));
          }
        } catch (_) {}
      };

      const load = async () => {
        try {
          const me = await apiGet('/api/me');
          const c = me.customer;
          who.textContent = c.email;
          get('full_name').value = c.full_name || '';
          get('phone').value = c.phone || '';
          get('company_name').value = c.company_name || '';
          get('orgnr').value = c.orgnr || '';
          get('vat_id').value = c.vat_id || '';
          get('marketing_opt_in').checked = !!c.marketing_opt_in;

          const billing = (me.addresses || []).find(a => a.type === 'billing');
          const shipping = (me.addresses || []).find(a => a.type === 'shipping');
          fillAddr('billing', billing);
          fillAddr('shipping', shipping);

          renderPreviews();
        } catch (err) {
          if (err && err.status === 401) {
            window.location.href = '/login/';
            return;
          }
          setStatus(statusEl, 'Kunde inte ladda konto.', 'error');
        }
      };

      // Live previews update for typing + browser autofill.
      for (const id of [
        'full_name','company_name','phone',
        'b_line1','b_line2','b_postal_code','b_city','b_region','b_country',
        's_line1','s_line2','s_postal_code','s_city','s_region','s_country'
      ]) {
        try {
          const el = get(id);
          if (!el) continue;
          el.addEventListener('input', renderPreviews);
          el.addEventListener('change', renderPreviews);
        } catch (_) {}
      }

      document.getElementById('save').addEventListener('click', async () => {
        try {
          setStatus(statusEl, 'Sparar…');
          await apiPut('/api/me', {
            full_name: get('full_name').value,
            phone: get('phone').value,
            company_name: get('company_name').value,
            orgnr: get('orgnr').value,
            vat_id: get('vat_id').value,
            marketing_opt_in: get('marketing_opt_in').checked,
          });
          setStatus(statusEl, 'Sparat.');
          renderPreviews();
        } catch (_) {
          setStatus(statusEl, 'Kunde inte spara.', 'error');
        }
      });

      document.getElementById('saveAddr').addEventListener('click', async () => {
        try {
          setStatus(status2El, 'Sparar…');
          await apiPut('/api/me-addresses', {
            billing: {
              line1: get('b_line1').value,
              line2: get('b_line2').value,
              postal_code: get('b_postal_code').value,
              city: get('b_city').value,
              region: get('b_region').value,
              country: get('b_country').value,
            },
            shipping: {
              line1: get('s_line1').value,
              line2: get('s_line2').value,
              postal_code: get('s_postal_code').value,
              city: get('s_city').value,
              region: get('s_region').value,
              country: get('s_country').value,
            }
          });
          setStatus(status2El, 'Sparat.');
          renderPreviews();
        } catch (_) {
          setStatus(status2El, 'Kunde inte spara.', 'error');
        }
      });

      document.getElementById('logout').addEventListener('click', async () => {
        try {
          await apiPost('/api/auth/logout', {});
        } catch (_) {}
        window.location.href = '/login/';
      });

      load();
    </script>
  </div>
</body>
</html>
